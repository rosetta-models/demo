version: "1.0"

steps:
  main_clone:
    type: git-clone
    git: rosetta-models
    repo: "${{CF_REPO_OWNER}}/${{CF_REPO_NAME}}"
    revision: "${{CF_REVISION}}"

  IsTriggeredByGitHubRelease:
    image: alpine
    commands:
      - if [[ '${{CF_RELEASE_TAG}}' == *'CF_RELEASE_TAG'* ]]; then cf_export IS_RELEASE=false; else cf_export IS_RELEASE=true; fi
  
  ReleaseNameForTag:
    image: alpine/git
    when:
      condition:
        all:
          releaseNameNotDefined: "${{IS_RELEASE}} == true"
    commands:
      - cf_export RELEASE_NAME=${{CF_RELEASE_TAG}}

  MvnSettings:
    image: alpine/git
    commands:
      - cf_export MVN_CLI_OPT="-Dmaven.repo.local=\"${{CF_VOLUME_PATH}}/${{CF_REPO_NAME}}_m2/repository\""

  ReleaseNameForBranch:
    image: alpine/git
    when:
      condition:
        all:
          releaseNameNotDefined: "${{IS_RELEASE}} == false"
    commands:
      - cf_export RELEASE_NAME=${{GLOBAL_RELEASE_VERSION}}.${{CF_BRANCH_TAG_NORMALIZED}}-SNAPSHOT

  Build:
    image: maven:3.9.11-eclipse-temurin-21-alpine
    working_directory: ./
    commands:
      - echo "${{ARTIFACT_REGISTRY_SA_KEY}}"|base64 -d>"${{CF_VOLUME_PATH}}"/sa
      - export GOOGLE_APPLICATION_CREDENTIALS="${{CF_VOLUME_PATH}}"/sa
      - mvn ${{MVN_CLI_OPT}} versions:set -DnewVersion=${{RELEASE_NAME}}
      - mvn ${{MVN_CLI_OPT}} clean deploy
